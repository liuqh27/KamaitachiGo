# KamaitachiGo 测试流程手册 v1.1

本文档提供当前版本 KamaitachiGo 的标准测试流程。

---

## 🚀 一键启动与测试

我们提供了一系列强大的脚本来自动化构建、部署、测试的全过程，这是当前推荐的测试方法。

### 步骤 1: 启动完整集群

请确保 `etcd` 服务正在运行。然后，在项目根目录打开 PowerShell 并执行：

```powershell
.\scripts\start_cluster.ps1
```

此脚本会自动完成以下所有操作：
-   **清理环境**: 强制停止所有残留的 `master`, `slave`, `gateway` 进程。
-   **构建项目**: 自动编译所有组件的最新代码到 `bin/` 目录下。
-   **启动服务**: 在最小化窗口中启动 Master, 2个 Slave, 和 Gateway 进程。
-   **健康检查**: 循环检查并确认所有服务都已成功启动并就绪。

脚本执行成功后，您将看到 `KamaitachiGo Cluster is UP and READY!` 的提示。

### 步骤 2: 运行压力测试

在集群启动后，打开一个新的 PowerShell 窗口，执行压测脚本。

#### 模拟热点数据访问（高命中率场景）

以下命令将模拟对 10 个热点数据的 10000 次高并发访问，用于验证缓存系统的性能。

```powershell
# 运行场景1进行压测
.\bin\benchmark_scenarios.exe -scenario 1 -requests 10000 -concurrent 50 -target "http://localhost:9000/data" -repeat 10
```

-   `-target "http://localhost:9000/data"`: 指定通过 Gateway 进行测试，以利用其一致性哈希路由。
-   `-repeat 10`: 表示仅生成 10 个不同的请求并重复它们，以模拟对热点数据的访问。

#### 模拟随机访问（低命中率场景）

移除 `-repeat` 参数即可模拟大量随机请求的场景，此场景下缓存命中率会很低，主要用于测试系统的极限 QPS。

```powershell
.\bin\benchmark_scenarios.exe -scenario 1 -requests 10000 -concurrent 50 -target "http://localhost:9000/data"
```

### 步骤 3: 查看集群状态与性能指标

测试完成后，您可以通过访问 Gateway 的 `/stats` 接口来实时查看整个集群的聚合统计数据。

```powershell
# 使用 PowerShell 查看，输出会格式化为易读的 JSON
Invoke-RestMethod -Uri http://localhost:9000/kamaitachi/api/data/v1/stats | ConvertTo-Json -Depth 5

# 或者使用 curl
curl http://localhost:9000/kamaitachi/api/data/v1/stats
```

您将能看到整个集群的缓存条目数、总命中数、总未命中数以及聚合后的缓存命中率。

### 步骤 4: 关闭集群

测试结束后，只需关闭所有由脚本启动的最小化窗口即可。`start_cluster.ps1` 脚本会在下次启动时自动清理任何残留进程。

---

## 📊 性能基准参考 (v1.1)

以下为在 `Intel Core i7-10700 CPU`, `32GB RAM`, `Windows 11` 环境下，运行一个2节点的Slave集群，在**热点数据场景**下测得的性能数据。

| 场景 | 描述 | 目标QPS | **实际QPS** | **缓存命中率** |
| :--- | :--- | :--- | :--- | :--- |
| **1** | 多实体、多指标查询 | 300 | **~1900** | **~99.7%** |
| **2** | 单实体、多指标查询 | 500 | **~2800** | **~99.8%** |
| **3** | 多实体、分页查询 | 10000 | **~2700** | **~99.8%** |
| **4** | 多实体、带日期查询 | 300 | **~2800** | **~99.8%** |

---

## 🐛 常见问题排查

### 问题1：`start_cluster.ps1` 启动服务失败

**症状**: 脚本在“Verifying services...”步骤卡住，并报告某个服务 `FAILED to start`。

**排查步骤**:
1.  **检查 etcd**: 确保 `etcd` 正在运行。
2.  **查看日志**: 在项目 `logs/` 目录下找到对应服务的日志文件（例如 `slave_8081.log`），查看最后的错误信息。
3.  **端口冲突**: 运行 `netstat -ano | findstr "8080"` (或其他端口) 检查端口是否被其他程序占用。

### 问题2：压测时出现大量 `failed` 请求

**症状**: `benchmark_scenarios.exe` 的结果中 `Failed` 字段大于 0。

**排查步骤**:
1.  **确认集群状态**: 重新运行 `scripts\start_cluster.ps1`，确保所有服务都 `is UP`。
2.  **查看服务日志**: 在压测期间，观察 `logs/` 目录下的日志，看是否有 `panic` 或其他致命错误。
3.  **检查压测命令**: 确认 `-target` 地址是否正确。

---
**最后更新**: 2025-12-26  
**版本**: v1.1

