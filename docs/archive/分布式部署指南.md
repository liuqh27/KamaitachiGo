# Kamaitachi 分布式部署指南

## 架构说明

```
            ┌──────────┐
            │  etcd    │  服务注册与发现
            └────┬─────┘
                 │
      ┌──────────┼──────────┐
      │          │          │
  ┌───▼──┐   ┌──▼───┐  ┌───▼──┐
  │Master│   │Slave1│  │Slave2│  数据节点 (SQLite)
  │:8080 │   │:8081 │  │:8082 │
  └───┬──┘   └──┬───┘  └───┬──┘
      │         │          │
      └────┬────┴────┬─────┘
           │         │
       ┌───▼─────────▼───┐
       │    Gateway      │  负载均衡
       │     :9000       │
       └─────────────────┘
              │
         ┌────▼────┐
         │ Client  │
         └─────────┘
```

## 快速启动

### 前提条件

1. **已编译的二进制文件**：
   - `bin/master.exe` - Master节点
   - `bin/slave.exe` - Slave节点
   - `bin/gateway.exe` - Gateway网关

2. **etcd服务**：
   - 下载并启动etcd
   - 默认端口: 2379

### 步骤1: 启动etcd

```powershell
# Windows下载etcd
# https://github.com/etcd-io/etcd/releases

# 启动etcd
.\etcd.exe
```

### 步骤2: 启动集群

```powershell
# 自动启动整个集群
.\start_cluster.ps1
```

脚本会自动：
1. 清理旧进程
2. 检查etcd
3. 启动Master节点 (端口8080)
4. 启动2个Slave节点 (端口8081, 8082)
5. 启动Gateway (端口9000)

### 步骤3: 验证集群

```powershell
# 检查各节点健康状态
Invoke-RestMethod -Uri "http://localhost:8080/health"  # Master
Invoke-RestMethod -Uri "http://localhost:8081/health"  # Slave1
Invoke-RestMethod -Uri "http://localhost:8082/health"  # Slave2
Invoke-RestMethod -Uri "http://localhost:9000/health"  # Gateway
```

### 步骤4: 运行压力测试

```powershell
# 通过Gateway进行测试（负载均衡）
.\simple_pressure_test.ps1 -Requests 5000 -Concurrent 100
```

## 手动启动（可选）

如果需要手动控制每个节点：

### 1. 启动Master

```powershell
.\bin\master.exe
# 默认配置文件: conf/master.ini
# 端口: 8080
```

### 2. 启动Slave1

```powershell
.\bin\slave.exe -config conf/slave.ini
# 端口: 8081
```

### 3. 启动Slave2

修改`conf/slave.ini`：
```ini
[server]
port = 8082
service_addr = localhost:8082

[cache]
snapshot_path = ./data/slave2_snapshot.dat
```

然后启动：
```powershell
.\bin\slave.exe -config conf/slave2.ini
```

### 4. 启动Gateway

```powershell
.\bin\gateway.exe
# 端口: 9000
```

## 配置说明

### Master配置 (conf/master.ini)

```ini
[server]
port = 8080
mode = master
service_name = kamaitachi-master
service_addr = localhost:8080

[cache]
max_bytes = 2147483648          # 2GB缓存
snapshot_path = ./data/master_snapshot.dat
snapshot_interval = 10           # 10分钟快照一次

[etcd]
endpoints = localhost:2379
prefix = /kamaitachi
ttl = 10                         # 10秒心跳
```

### Slave配置 (conf/slave.ini)

```ini
[server]
port = 8081
mode = slave
service_name = kamaitachi-slave
service_addr = localhost:8081

[cache]
max_bytes = 2147483648
snapshot_path = ./data/slave_snapshot.dat
snapshot_interval = 10

[etcd]
endpoints = localhost:2379
prefix = /kamaitachi
ttl = 10
```

### Gateway配置 (conf/gateway.ini)

```ini
[server]
port = 9000
mode = gateway
service_name = kamaitachi-gateway
service_addr = localhost:9000

[etcd]
endpoints = localhost:2379
prefix = /kamaitachi
ttl = 10
```

## API访问

### 通过Master直接访问

```bash
POST http://localhost:8080/kamaitachi/api/data/v1/snapshot
```

### 通过Gateway访问（推荐）

注意：Gateway 只代理以 `/data/` 为前缀的请求（路由注册为 `/data/*`），并在转发给后端节点时会去掉该 `/data` 前缀。

因此，通过 Gateway 访问时请使用以下格式：

```bash
POST http://localhost:9000/data/kamaitachi/api/data/v1/snapshot
```

示例说明：
- 外部请求发送到 `http://localhost:9000/data/...`。
- Gateway 接收后会将路径中 `/data` 前缀去掉，然后将请求转发到后端实际路径 `/kamaitachi/...`。

Gateway会自动：
- 负载均衡到多个节点
- 健康检查
- 故障转移

## 性能优化

### 1. 增加节点数量

启动更多Slave节点以提高并发处理能力：

```powershell
# Slave3
.\bin\slave.exe -config conf/slave3.ini

# Slave4
.\bin\slave.exe -config conf/slave4.ini
```

### 2. 调整缓存大小

修改配置文件中的`max_bytes`：

```ini
[cache]
max_bytes = 4294967296  # 4GB
```

### 3. 调整连接池

在代码中修改SQLite连接池配置：

```go
db.SetMaxOpenConns(20)   # 增加最大连接数
db.SetMaxIdleConns(10)   # 增加空闲连接数
```

## 监控与管理

### 查看etcd中的服务注册

```powershell
# 使用etcdctl查看注册的服务
etcdctl get --prefix /kamaitachi
```

### 查看节点状态

```powershell
# 所有节点的健康检查
$nodes = @("8080", "8081", "8082", "9000")
foreach ($port in $nodes) {
    try {
        $response = Invoke-RestMethod -Uri "http://localhost:$port/health"
        Write-Host "Port $port : OK" -ForegroundColor Green
    } catch {
        Write-Host "Port $port : FAIL" -ForegroundColor Red
    }
}
```

### 停止集群

```powershell
# 停止所有节点
Get-Process | Where-Object {$_.Name -match "master|slave|gateway"} | Stop-Process -Force
```

## 故障排查

### 问题1: etcd连接失败

**现象**: 
```
Failed to connect to etcd: context deadline exceeded
```

**解决**:
1. 确认etcd已启动: `curl http://localhost:2379/version`
2. 检查防火墙
3. 检查etcd地址配置

### 问题2: 端口被占用

**现象**:
```
bind: address already in use
```

**解决**:
```powershell
# 查找占用端口的进程
netstat -ano | findstr ":8080"

# 停止进程
taskkill /PID <进程ID> /F
```

### 问题3: 节点无法注册到etcd

**现象**:
```
Failed to register service
```

**解决**:
1. 检查etcd连接
2. 检查service_addr配置是否正确
3. 确认网络连接

## 压力测试结果预期

### 单节点
- QPS: 150-200
- 延迟: P50 < 5ms

### 3节点集群（通过Gateway）
- QPS: 400-600
- 延迟: P50 < 10ms

### 5节点集群（通过Gateway）
- QPS: 1000+
- 延迟: P50 < 15ms

## 生产部署建议

1. **节点数量**: 至少3个Master + 5个Slave
2. **数据库**: 每个节点独立SQLite或共享分布式数据库
3. **监控**: 接入Prometheus + Grafana
4. **日志**: 集中日志收集（ELK）
5. **备份**: 定期备份数据和快照文件
6. **高可用**: etcd集群部署（3/5/7节点）

## 下一步优化

1. 实现Gateway的完整负载均衡逻辑
2. 添加节点动态发现和摘除
3. 实现数据一致性机制
4. 添加更多监控指标
5. 实现自动扩缩容

